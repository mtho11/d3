<!DOCTYPE html>
<html>
<head>
    <title>New RHQ d3 Bar/Area Chart Tester</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="jquery.tipsy.js"></script>
    <link rel="stylesheet" href="tipsy.css" type="text/css" />
    <style>
        body {
            font-family: "Liberation Sans", Arial, Helvetica, sans-serif;
            font-size: 10px;
            color: #50505a;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

            /* Horizontal gridlines */
        .grid .tick {
            stroke: #f7f7f7;
        }

        .y.axis  .tick.minor {

            stroke: #a7a7ac;
        }

        .y.axis  text {
            font-family: "Liberation Sans", Arial, Helvetica, sans-serif;
            font-size: 10px;
            font-weight: lighter;
            font-style: normal;
            stroke: #50505a;
        }

        .y.axis path {
            display: none;
        }
    </style>
    <script type='text/javascript'>
        $(function() {
            $('a[rel=tipsy]').tipsy({fade: true, gravity: 'n'});
        });
    </script>
</head>
<body>
<span>New Area/Bar Chart Tester</span>

<div>
    <div id="rChart-myChart" style="height: 320px;">
        <svg>
            <defs>
                <linearGradient id="headerGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#707883;stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:#425b64;stop-opacity:1"/>
                </linearGradient>
                <linearGradient id="leaderBarGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#d3d3d6;stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:#d3d3d6;stop-opacity:1"/>
                </linearGradient>
                <linearGradient id="heavyLeaderBarGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#a7a7ac;stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:#a7a7ac;stop-opacity:1"/>
                </linearGradient>
                <linearGradient id="topBarGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#067aba;stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:#1278a8;stop-opacity:1"/>
                </linearGradient>
                <linearGradient id="bottomBarGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#6bc0e6;stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:#388bb0;stop-opacity:1"/>
                </linearGradient>
                <pattern id="grayStripes" patternUnits="userSpaceOnUse" x="0" y="0"
                         width="6" height="3">
                    <path d="M 0 0 6 0" style="stroke:#dfdfdf; fill:none;"/>
                </pattern>
                <pattern id="redStripes" patternUnits="userSpaceOnUse" x="0" y="0"
                         width="6" height="3">
                    <path d="M 0 0 6 0" style="stroke:red; fill:none;"/>
                </pattern>
            </defs>
        </svg>
    </div>
</div>

<script type="text/javascript">

var chartId = "myChart",
        chartHandle = "#rChart-" + chartId,
        chartSelection = chartHandle + " svg",
        yAxisLabel = "milliseconds",
        yAxisUnits = "milliseconds",
        resourceName = "RHQ Agent - Agent-Server Clock Difference",
        xAxisLabel = "Time";


var json60hour = eval(
        [
            { x: 1355223583487, nodata: true },
            { x: 1355227183487, nodata: true },
            { x: 1355230783487, nodata: true },
            { x: 1355234383487, nodata: true },
            { x: 1355237983487, nodata: true },
            { x: 1355241583487, nodata: true },
            { x: 1355245183487, nodata: true },
            { x: 1355248783487, nodata: true },
            { x: 1355252383487, high: 2.004865139404956, low: 2.004865139404956, y: 2.004865139404956},
            { x: 1355255983487, high: 1.8011317110918028, low: 1.4991030366830513, y: 1.6666677848054239},
            { x: 1355259583487, high: 1.798992564164068, low: 1.4991105277535328, y: 1.6499923999594734},
            { x: 1355263183487, high: 1.7990315213643322, low: 1.499180448021748, y: 1.64999181929329},
            { x: 1355266783487, high: 1.8010025580906706, low: 1.4991654645580625, y: 1.6666663786219136},
            { x: 1355270383487, high: 1.8010235817356197, low: 1.4991479842289632, y: 1.666704599427901},
            { x: 1355273983487, high: 1.8010355954673938, low: 1.5991018378011017, y: 1.700000394190521},
            { x: 1355277583487, high: 1.7009582064563038, low: 1.5008379678653916, y: 1.6499917297924063},
            { x: 1355281183487, nodata: true },
            { x: 1355284783487, high: 3.60000600001, low: 0.5075370884354096, y: 2.053771544222705},
            { x: 1355288383487, nodata: true },
            { x: 1355291983487, nodata: true },
            { x: 1355295583487, nodata: true },
            { x: 1355299183487, nodata: true },
            { x: 1355302783487, nodata: true },
            { x: 1355306383487, nodata: true },
            { x: 1355309983487, nodata: true },
            { x: 1355313583487, nodata: true },
            { x: 1355317183487, nodata: true },
            { x: 1355320783487, high: 3.6000120000400004, low: 0.14818279645978663, y: 2.6370457824680025},
            { x: 1355324383487, high: 3.60000600001, low: 3.2999945000091664, y: 3.4500010555668514},
            { x: 1355327983487, high: 3.60000600001, low: 3.2999945000091664, y: 3.449999111115926},
            { x: 1355331583487, high: 3.60000600001, low: 3.2999945000091664, y: 3.4500010555603704},
            { x: 1355335183487, high: 3.5999940000099997, low: 3.3000055000091666, y: 3.4500007777887034},
            { x: 1355338783487, high: 3.7, low: 3.3000000000000003, y: 3.4833323888970376},
            { x: 1355342383487, high: 3.5999940000099997, low: 3.3000000000000003, y: 3.449999972231991},
            { x: 1355345983487, high: 4.0, low: 3.2999945000091664, y: 3.533334277785741},
            { x: 1355349583487, high: 3.6, low: 3.2999945000091664, y: 3.4499981111142595},
            { x: 1355353183487, high: 6.800011333352222, low: 2.999995000008333, y: 3.983335444450741},
            { x: 1355356783487, high: 3.60000600001, low: 3.3000000000000003, y: 3.450000027781065},
            { x: 1355360383487, high: 3.6, low: 3.3000000000000003, y: 3.4499999444508336},
            { x: 1355363983487, high: 3.6, low: 3.3000000000000003, y: 3.4499999999999997},
            { x: 1355367583487, high: 3.6, low: 3.3000000000000003, y: 3.475000000004861},
            { x: 1355371183487, nodata: true },
            { x: 1355374783487, nodata: true },
            { x: 1355378383487, nodata: true },
            { x: 1355381983487, nodata: true },
            { x: 1355385583487, nodata: true },
            { x: 1355389183487, nodata: true },
            { x: 1355392783487, nodata: true },
            { x: 1355396383487, nodata: true },
            { x: 1355399983487, nodata: true },
            { x: 1355403583487, nodata: true },
            { x: 1355407183487, high: 3.5000058333430557, low: 0.12017687262337716, y: 2.6050442181607054},
            { x: 1355410783487, high: 3.5999940000099997, low: 3.2999945000091664, y: 3.4499990555603706},
            { x: 1355414383487, high: 3.60000600001, low: 3.2999945000091664, y: 3.4500010000079633},
            { x: 1355417983487, high: 3.6, low: 3.3000000000000003, y: 3.4499999444475926},
            { x: 1355421583487, high: 3.6, low: 3.3000000000000003, y: 3.4499999444508336},
            { x: 1355425183487, high: 3.7, low: 3.2999945000091664, y: 3.483332388893704},
            { x: 1355428783487, high: 3.60000600001, low: 3.2999945000091664, y: 3.4500010555603704},
            { x: 1355432383487, high: 3.8000000000000003, low: 3.3000000000000003, y: 3.5333333333365746},
            { x: 1355435983487, high: 3.5999940000099997, low: 3.3000000000000003, y: 3.4499999722255095}
        ]
);

var jsonTest = eval([{ x:1355412448955, high:33.715, low:33.715, y:33.715},{ x:1355412928955, high:33.418, low:33.418, y:33.418},{ x:1355413408955, high:33.112, low:33.112, y:33.112},{ x:1355413888955, nodata:true },{ x:1355414368955, high:32.789, low:32.789, y:32.789},{ x:1355414848955, high:32.514, low:32.514, y:32.514},{ x:1355415328955, high:32.234, low:32.234, y:32.234},{ x:1355415808955, high:31.954, low:31.954, y:31.954},{ x:1355416288955, nodata:true },{ x:1355416768955, high:31.698, low:31.698, y:31.698},{ x:1355417248955, high:31.418, low:31.418, y:31.418},{ x:1355417728955, high:31.13, low:31.13, y:31.13},{ x:1355418208955, high:30.866, low:30.866, y:30.866},{ x:1355418688955, nodata:true },{ x:1355419168955, high:30.586000000000002, low:30.586000000000002, y:30.586000000000002},{ x:1355419648955, high:30.332, low:30.332, y:30.332},{ x:1355420128955, high:30.101, low:30.101, y:30.101},{ x:1355420608955, high:29.856, low:29.856, y:29.856},{ x:1355421088955, nodata:true },{ x:1355421568955, high:29.604, low:29.604, y:29.604},{ x:1355422048955, high:29.373, low:29.373, y:29.373},{ x:1355422528955, high:29.128, low:29.128, y:29.128},{ x:1355423008955, high:28.883, low:28.883, y:28.883},{ x:1355423488955, nodata:true },{ x:1355423968955, high:28.652, low:28.652, y:28.652},{ x:1355424448955, high:28.407, low:28.407, y:28.407},{ x:1355424928955, high:28.157, low:28.157, y:28.157},{ x:1355425408955, high:27.959, low:27.959, y:27.959},{ x:1355425888955, nodata:true },{ x:1355426368955, high:27.749000000000002, low:27.749000000000002, y:27.749000000000002},{ x:1355426848955, high:27.539, low:27.539, y:27.539},{ x:1355427328955, high:27.341, low:27.341, y:27.341},{ x:1355427808955, high:27.119, low:27.119, y:27.119},{ x:1355428288955, nodata:true },{ x:1355428768955, high:26.903000000000002, low:26.903000000000002, y:26.903000000000002},{ x:1355429248955, high:26.705000000000002, low:26.705000000000002, y:26.705000000000002},{ x:1355429728955, high:26.495, low:26.495, y:26.495},{ x:1355430208955, high:26.285, low:26.285, y:26.285},{ x:1355430688955, nodata:true },{ x:1355431168955, high:26.087, low:26.087, y:26.087},{ x:1355431648955, high:25.877, low:25.877, y:25.877},{ x:1355432128955, high:25.662, low:25.662, y:25.662},{ x:1355432608955, high:25.488, low:25.488, y:25.488},{ x:1355433088955, nodata:true },{ x:1355433568955, high:25.313, low:25.313, y:25.313},{ x:1355434048955, high:25.138, low:25.138, y:25.138},{ x:1355434528955, high:24.973, low:24.973, y:24.973},{ x:1355435008955, high:24.783, low:24.783, y:24.783},{ x:1355435488955, nodata:true },{ x:1355435968955, high:24.603, low:24.603, y:24.603},{ x:1355436448955, high:24.428, low:24.428, y:24.428},{ x:1355436928955, high:24.253, low:24.253, y:24.253},{ x:1355437408955, high:24.088, low:24.088, y:24.088},{ x:1355437888955, nodata:true },{ x:1355438368955, high:23.913, low:23.913, y:23.913},{ x:1355438848955, high:23.738, low:23.738, y:23.738},{ x:1355439328955, high:23.568, low:23.568, y:23.568},{ x:1355439808955, high:23.398, low:23.398, y:23.398},{ x:1355440288955, nodata:true },{ x:1355440768955, high:23.223, low:23.223, y:23.223}]);

var negativeY = eval([
    { x: 1355412448955, high: 2.0, low: 2.0, y: 2.0},
    { x: 1355412928955, nodata: true },
    { x: 1355413408955, high: 2.0, low: 2.0, y: 2.0},
    { x: 1355413888955, high: 2.0, low: 2.0, y: 2.0},
    { x: 1355414368955, high: 2.0, low: 2.0, y: 2.0},
    { x: 1355414848955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355415328955, nodata: true },
    { x: 1355415808955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355416288955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355416768955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355417248955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355417728955, nodata: true },
    { x: 1355418208955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355418688955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355419168955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355419648955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355420128955, nodata: true },
    { x: 1355420608955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355421088955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355421568955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355422048955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355422528955, nodata: true },
    { x: 1355423008955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355423488955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355423968955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355424448955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355424928955, nodata: true },
    { x: 1355425408955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355425888955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355426368955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355426848955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355427328955, nodata: true },
    { x: 1355427808955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355428288955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355428768955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355429248955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355429728955, nodata: true },
    { x: 1355430208955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355430688955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355431168955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355431648955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355432128955, nodata: true },
    { x: 1355432608955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355433088955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355433568955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355434048955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355434528955, nodata: true },
    { x: 1355435008955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355435488955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355435968955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355436448955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355436928955, nodata: true },
    { x: 1355437408955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355437888955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355438368955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355438848955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355439328955, nodata: true },
    { x: 1355439808955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355440288955, high: 0.0, low: 0.0, y: 0.0},
    { x: 1355440768955, high: 0.0, low: 0.0, y: 0.0}
]);


function draw(data) {
    "use strict";

    var margin = {top: 10, right: 5, bottom: 30, left: 40},
            width = 850 - margin.left - margin.right,
            height = 250 - margin.top - margin.bottom,
            titleHeight = 43, titleSpace = 10;

    var avg = d3.mean(data.map(function (d) {
        return d.y;
    }));
    var peak = d3.max(data.map(function (d) {
        return d.high;
    }));
    var min = d3.min(data.map(function (d) {
        return d.low;
    }));


    var timeScale = d3.time.scale()
            .range([0, width])
            .domain(d3.extent(data, function (d) {
                return d.x;
            }));

    // adjust the min scale so blue low line is not in axis
    var determineLowBound = function (min, peak) {
        var newLow = min - ((peak - min) * 0.1);
        if (newLow < 0) {
            return 0;
        } else {
            return newLow;
        }
    };
    var lowBound = determineLowBound(min,peak);
    var highBound = peak + ((peak - min) * 0.1);

    var yScale = d3.scale.linear()
            .clamp(true)
            .rangeRound([height, 0])
            .domain([lowBound, highBound]);

//    var xAxis = d3.svg.axis()
//            .scale(timeScale)
//            .ticks(0)
//            .tickSize(0, 0, 0)
//            .orient("bottom");

    var yAxis = d3.svg.axis()
            .scale(yScale)
            .tickSubdivide(2)
            .ticks(10)
            .tickSize(4, 4, 0)
            .orient("left");


    var interpolation = "basis";
    var avgLine = d3.svg.line()
            .interpolate(interpolation)
            .x(function (d) {
                return timeScale(d.x);
            })
            .y(function (d) {
                return yScale((avg));
            });
    var peakLine = d3.svg.line()
            .interpolate(interpolation)
            .x(function (d) {
                return timeScale(d.x);
            })
            .y(function (d) {
                return yScale((peak));
            });
    var minLine = d3.svg.line()
            .interpolate(interpolation)
            .x(function (d) {
                return timeScale(d.x);
            })
            .y(function (d) {
                return yScale(min);
            });

    // our own x-axis because ours is custom
    var xAxisLine = d3.svg.line()
            .interpolate(interpolation)
            .x(function (d) {
                return timeScale(d.x);
            })
            .y(function (d) {
                return yScale(lowBound);
            });


    // create the actual chart group
    var chart = d3.select(chartSelection);


    var createHeader = (function (resourceName, minLabel, minValue, avgLabel, avgValue, highLabel, highValue) {
        var fontSize = 14,
                yTitle = 37,
                fgColor = "#FFFFFF",
                baseX = 490,
                xInc = 50;


        // title/header
        var title = chart.append("g").append("rect")
                .attr("class", "title")
                .attr("x", 10)
                .attr("y", margin.top)
                .attr("height", titleHeight)
                .attr("width", width + 30 + margin.left)
                .attr("fill", "url(#headerGrad)");

        chart.append("text")
                .attr("class", "titleName")
                .attr("x", 30)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("font-weight", "bold")
                .attr("text-anchor", "left")
                .text(resourceName)
                .attr("fill", fgColor);


        chart.append("text")
                .attr("class", "minLabel")
                .attr("x", baseX)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("font-weight", "bold")
                .attr("text-anchor", "left")
                .text(minLabel)
                .attr("fill", fgColor);

        chart.append("text")
                .attr("class", "minText")
                .attr("x", baseX + xInc)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("text-anchor", "left")
                .text(minValue.toPrecision(3))
                .attr("fill", fgColor);

        //avg
        chart.append("text")
                .attr("class", "avgLabel")
                .attr("x", baseX + 2 * xInc)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("font-weight", "bold")
                .attr("text-anchor", "left")
                .text(avgLabel)
                .attr("fill", fgColor);

        chart.append("text")
                .attr("class", "avgText")
                .attr("x", baseX + 3 * xInc)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("text-anchor", "left")
                .text(avgValue.toPrecision(3))
                .attr("fill", fgColor);

        // high
        chart.append("text")
                .attr("class", "highLabel")
                .attr("x", baseX + 4 * xInc)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("font-weight", "bold")
                .attr("text-anchor", "left")
                .text(highLabel)
                .attr("fill", fgColor);

        chart.append("text")
                .attr("class", "highText")
                .attr("x", baseX + 5 * xInc)
                .attr("y", yTitle)
                .attr("font-size", fontSize)
                .attr("text-anchor", "left")
                .text(highValue.toPrecision(3))
                .attr("fill", fgColor);

    });
    createHeader(yAxisLabel, "Min -", min, "Avg -", avg, "High -", peak);


    var svg = chart.append("g")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top - titleHeight - titleSpace + margin.bottom)
            .attr("transform", "translate(" + margin.left + "," + (+titleHeight + titleSpace + margin.top) + ")");


    // create the y axis grid lines
    svg.append("g").classed("grid y_grid", true)
            .call(d3.svg.axis()
                    .scale(yScale)
                    .orient("left")
                    .ticks(10)
                    .tickSize(-width, 0, 0)
                    .tickFormat("")
            );


    var barOffset = 2, pixelsOffHeight = 0;

    // The gray bars at the bottom leading up
    svg.selectAll("rect.leaderBar")
            .data(data)
            .enter().append("rect")
            .attr("class", "leaderBar")
            .attr("x", function (d) {
                return timeScale(d.x);
            })
            .attr("y", function (d) {
                if (d.down || d.nodata) {
                    return yScale(highBound);
                } else {
                    return yScale(d.low);
                }
            })
            .attr("height", function (d) {
                if (d.down || d.nodata) {
                    return height - yScale(highBound) - pixelsOffHeight;
                } else {
                    return height - yScale(d.low) - pixelsOffHeight;
                }
            })
            .attr("width", function (d) {
                return  (width / data.length - barOffset  );
            })

            .attr("opacity", ".55")
            .attr("fill", function (d, i) {
                if (d.down) {
                    return  "url(#redStripes)";
                } else if (d.nodata) {
                    return  "url(#grayStripes)";
                } else {
                    if (i % 10 == 0) {
                        return  "url(#heavyLeaderBarGrad)";
                    } else {
                        return  "url(#leaderBarGrad)";
                    }
                }
            });

    // custom x-axis
    svg.selectAll("rect.customXAxis")
            .data(data)
            .enter().append("rect")
            .attr("class", "customXAxis")
            .attr("x", function (d) {
                return timeScale(d.x);
            })
            .attr("y", function (d) {
                return  yScale(lowBound) + 2;
            })
            .attr("height", function (d, i) {
                if (i % 10 == 0) {
                    return height - yScale(lowBound) + 3;
                } else {
                    return height - yScale(lowBound) + 3;
                }
            })
            .attr("width", function (d) {
                return  (width / data.length - barOffset  );
            })
            .attr("opacity", 1)
            .attr("fill", function (d, i) {
                if (i % 10 == 0) {
                    return  "#a7a7ac";
                } else {
                    return  "#d3d3d6";
                }
            });

    // Custom knobs on xaxis every 5th one
    svg.selectAll("rect.customXAxisKnobs")
            .data(data)
            .enter().append("rect")
            .attr("class", "customXAxisKnobs")
            .attr("x", function (d) {
                return timeScale(d.x) + 4;
            })
            .attr("y", function (d) {
                return  yScale(lowBound) + 3;
            })
            .attr("height", function (d, i) {
                if (i % 10 == 0) {
                    return (height - yScale(lowBound)) + 4;
                } else {
                    return 0;
                }
            })
            .attr("width", function (d) {
                return  (((width / data.length - barOffset) / 2) - 3 );
            })
            .attr("opacity", 1)
            .attr("fill", function (d, i) {

                if (i % 10 == 0) {
                    return  "#a7a7ac";
                } else {
                    return  "#d3d3d6";
                }
            });
    // Custom knobs on
    svg.selectAll("rect.customXAxisKnobsSmall")
            .data(data)
            .enter().append("rect")
            .attr("class", "customXAxisKnobsSmall")
            .attr("x", function (d) {
                return timeScale(d.x) + 5;
            })
            .attr("y", function (d) {
                return  yScale(lowBound) + 5;
            })
            .attr("height", function (d, i) {
                if (i % 10 != 0) {
                    return (height - yScale(lowBound)) + 2;
                } else {
                    return 0;
                }
            })
            .attr("width", function (d) {
                return  (((width / data.length - barOffset) / 2) - 4);
            })
            .attr("opacity", 1)
            .attr("fill", function (d, i) {

                if (i % 10 == 0) {
                    return  "#a7a7ac";
                } else {
                    return  "#d3d3d6";
                }
            });


    var dateFormatter = d3.time.format("%I:%M:%S %P");

    // the labels for x axis
    svg.selectAll("rect.customXAxisLabel")
            .data(data)
            .enter().append("text")
            .attr("class", "customXAxisLabel")
            .attr("x", function (d) {
                return timeScale(d.x);
            })
            .attr("y", function (d) {
                return  yScale(lowBound) + 10;
            })
            .attr("dy", "1.2em")
            .attr("dx", function (d) {
                return  (((width / data.length - barOffset) / 2) - 2 );
            })
            .attr("text-anchor", "left").
            text(function (d, i) {
                var date = new Date(+d.x);
                if (i % 10 == 0) {
                    return dateFormatter(date);
                } else {
                    return  "";
                }
            })
            .attr("fill", "#50505a");


    // upper portion representing avg to high
    svg.selectAll("rect.high")
            .data(data)
            .enter().append("rect")
            .attr("class", "high")
            .attr("x", function (d) {
                return timeScale(d.x);
            })
            .attr("y", function (d) {
                return isNaN(d.high) ? height  : yScale(d.high);
            })
            .attr("height", function (d) {
                if (d.down || d.nodata) {
                    return height - yScale(lowBound);
                } else {
                    return  yScale(d.y) - yScale(d.high);
                }
            })
            .attr("width", function (d) {
                return  (width / data.length - barOffset  );
            })
            .attr("opacity", 0.8)
        //.attr("fill", "#084581");
            .attr("fill", "url(#topBarGrad)");


    // lower portion representing avg to low
    svg.selectAll("rect.low")
            .data(data)
            .enter().append("rect")
            .attr("class", "low")
            .attr("x", function (d) {
                return timeScale(d.x);
            })
            .attr("y", function (d) {
                return isNaN(d.y) ? height : d.y;
            })
            .attr("height", function (d) {
                if (d.down || d.nodata) {
                    return height - yScale(lowBound);
                } else {
                    return  yScale(d.low) - yScale(d.y);
                }
            })
            .attr("width", function (d) {
                return  (width / data.length - barOffset );
            })
            .attr("opacity", 0.8)
        //.attr("fill", "#42aadf");
            .attr("fill", "url(#bottomBarGrad)");

    // create x-axis
//    svg.append("g")
//            .attr("class", "x axis")
//            .attr("transform", "translate(0," + height + ")")
//            .call(xAxis);


    // create y-axis
    svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90),translate( -60,0)")
            .attr("y", -30)
        //.attr("dy", ".71em")
            .attr("font-size", "10px")
            .attr("font-family", "'Liberation Sans', Arial, Helvetica, sans-serif")
            .attr("letter-spacing", "3")
            .style("text-anchor", "end")
            .text(yAxisUnits === "NONE" ? "" : yAxisUnits);

    console.log("finished axes");

    // peak Line (must be before line.high to look right
    svg.append("path")
            .datum(data)
            .attr("class", "peakLine")
            .attr("fill", "none")
            .attr("stroke", "#ff8a9a")
            .attr("stroke-width", "1")
            .attr("stroke-dasharray", "3,3")
            .attr("stroke-opacity", ".4")
            .attr("d", peakLine);

    // min Line
    svg.append("path")
            .datum(data)
            .attr("class", "minLine")
            .attr("fill", "none")
            .attr("stroke", "#8ad6ff")
            .attr("stroke-width", "1")
            .attr("stroke-dasharray", "3,3")
        //.attr("stroke-dasharray", "20,10,5,5,5,10")
            .attr("stroke-opacity", ".6")
            .attr("d", minLine);

    // avg line
    svg.append("path")
            .datum(data)
            .attr("class", "avgLine")
            .attr("fill", "none")
            .attr("stroke", "#b0d9b0")
            .attr("stroke-width", "1")
            .attr("stroke-dasharray", "3,3")
            .attr("stroke-opacity", ".6")
            .attr("d", avgLine);
    // xaxis line
    svg.append("path")
            .datum(data)
            .attr("class", "xAxisLine")
            .attr("fill", "none")
            .attr("stroke", "#cccdcf")
            .attr("stroke-width", "1")
        //.attr("stroke-dasharray", "3,3")
        //.attr("stroke-opacity", ".6")
            .attr("d", xAxisLine);




    $('svg rect').tipsy({
        gravity: 'w',
        html: true,
        title: function() {
            var d = this.__data__ ;
            var date = new Date(d.x);
            var timeFormatter = d3.time.format("%I:%M:%S %P");
            var dateFormatter = d3.time.format("%m/%d/%y");
            return '<div style="text-align: left;"><span style="width:50px;font-weight: bold;color:#d3d3d6";">Time:  </span>' +timeFormatter(date)+ '</div>'+
                   '<div style="text-align: left;"><span style="width:50px;font-weight: bold;color:#d3d3d6"";">Date:  </span>' +dateFormatter(date)+ '</div>'+
                    '<div style="text-align: left;"><span style="width:50px;font-weight: bold;color:#ff8a9a";">High:  </span>'
                    + d.high.toPrecision(3)+'</div><div style="text-align: left;"><span style="width:50px;font-weight: bold;color: #b0d9b0";">Avg:  </span>'+ d.y.toPrecision(3)+
                    '</div><div style="text-align: left;"><span style="width:50px;font-weight: bold;color:#8ad6ff";">Low:  </span>'+ d.low.toPrecision(3)+ '</div>';
        }
    });



    console.log("finished drawing paths");
}
draw(json60hour);

</script>
</body>
</html>
